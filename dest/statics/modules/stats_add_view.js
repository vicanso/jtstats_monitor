(function(){define("StatsAddView",["jquery","underscore","Backbone"],function(a,b,c){var d,e,f,g,h,i;i=a("underscore"),d=a("jquery"),e=a("Backbone"),g=function(){var a,b,c;return b=function(a,b){return'<div class="col-xs-6 col-sm-4"><div class="input-group"><span class="input-group-addon">'+a+'</span><input type="text" class="form-control" placeholder="'+b+'"></div></div>'},c=function(a){var b,c;return c='<div class="col-xs-6 col-sm-4"><div class="btn-group dateList">',b=i.template('<button type="button" class="btn btn-default" data-start="<%= start %>" data-end="<%= end %>"><%= text %></button>'),i.each(a,function(a){return c+=b(a)}),c+="</div></div>"},a=[{text:"当天",start:0,end:0},{text:"7天",start:-6,end:0},{text:"15天",start:-14,end:0},{text:"30天",start:-29,end:0},{text:"当月",start:"currentMonth",end:0}],'<div class="row dateRow">'+b("开始日期","请输入开始日期(YYYY-MM-DD)")+b("结束日期","请输入结束日期(YYYY-MM-DD)")+c(a)+"</div>"}(),h=function(){var a,b,c,d;return a=i.template('<div class="col-xs-6 col-sm-4"><button class="btn <%= itemClass %>"><%= name %></button></div>'),c=function(b){return a(b)},d='<div class="row function"><div class="col-xs-6 col-sm-4"><div class="input-group"><span class="input-group-addon">名称</span><input type="text" class="form-control" placeholder="请输入该统计的名称"></div></div>',b=[{name:"预览",itemClass:"preview btn-danger"},{name:"保存",itemClass:"save btn-success"}],i.each(b,function(a){return d+=c(a)}),d+="</div>"}(),f=e.View.extend({events:function(){return{"click .categorySelector .dropdown-menu li":"selectCategory","click .keySelector .dropdown-menu li":"selectKey","click .typeSelector .dropdown-menu li":"selectType","click .intervalSelector .dropdown-menu li":"selectInterval","click .dateList .btn":"selectDate","click .function .preview":"preview","click .function .save":"save","click .addCategory":"addCategory","click .deleteCategory":"deleteCategory"}},initialize:function(){return this.render()},getSelector:function(a,b,c,d){var e,f;return null==d&&(d=""),f='<ul class="dropdown-menu" role="menu">',i.each(a,function(a){return f+='<li><a href="javascript:;"><span class="glyphicon"></span>'+a+"</a></li>"}),f+="</ul>",e='<div class="col-xs-6 col-sm-4 '+b+' selector"><div class="input-group"><div class="input-group-btn"><button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">'+c+'<span class="caret"></span></button>'+f+'</div><input type="text" class="form-control" value="'+d+'"></input></div></div>'},getCategoryList:function(){return this.getSelector(JT_GLOBAL.collections,"categorySelector","请选择分类")},getTypeList:function(){return this.getSelector(["line","column","pie","gauge","columnFresh"],"typeSelector","请选择类型")},getIntervalList:function(){return this.getSelector(["1m","10m","30m","1h","2h","6h","12h","1d"],"intervalSelector","请选择时间间隔(秒)",60)},getKeyList:function(a){return this.getSelector(a,"keySelector","请选择key")},addCategory:function(){var a;return a='<div class="row selectorList stats">'+this.getCategoryList()+this.getKeyList()+'<div class="col-xs-6 col-sm-4"><button class="deleteCategory btn btn-warning">删除</button></div></div>',this.$el.find(".selectorList:last").before(a),this},deleteCategory:function(a){return d(a.target).closest(".selectorList").remove(),this},showKeySelector:function(a,b){return d.ajax({url:"/collection/"+a+"/keys",dataType:"json"}).success(function(a){return function(c){var e,f,g;return f=d(a.getKeyList(c)),g=a.$el.find(".selectorList").find(".keySelector").eq(b),e=!1,f.find(".dropdown-menu").on("click",function(){e=!0}),f.find(".input-group-btn").on("hide.bs.dropdown",function(a){e&&a.preventDefault(),e=!1}),g.after(f),g.remove()}}(this)).error(function(){}),this},selectKey:function(a){var b,c,e;return c=d(a.target),c.toggleClass("selected"),c.find(".glyphicon").toggleClass("glyphicon-ok"),e=c.closest(".dropdown-menu").find(".selected"),b=i.map(e,function(a){return d(a).text()}),c.closest(".keySelector").find("input").val(b.join(",")),a.preventDefault()},selectType:function(a){var b,c;return b=d(a.target),c=b.text(),this.$el.find(".typeSelector input").val(c)},selectCategory:function(a){var b,c,e,f;return f=d(a.target),b=f.text(),c=f.closest(".categorySelector"),c.find("input").val(b),e=this.$el.find(".categorySelector").index(c),this.showKeySelector(b,e)},selectDate:function(a){var b,c,e,f;return e=d(a.target),f=e.data("start"),b=e.data("end"),c=this.$el.find(".dateRow .form-control"),c.eq(0).val(f),c.eq(1).val(b)},selectInterval:function(a){var b,c,e;return b=d(a.target).text(),e={m:60,h:3600,d:86400},c=e[b.charAt(b.length-1).toLowerCase()],this.$el.find(".intervalSelector input").val(window.parseInt(b)*c)},preview:function(){var a;return a=this.getConfig(),a?this.trigger("preview",a):void 0},save:function(){var a;return a=this.getConfig(),a?d.ajax({url:"/config",type:"post",dataType:"json",contentType:"application/json",data:JSON.stringify(a)}).success(function(a){return console.dir(a)}).error(function(a){return console.dir(a)}):void 0},getConfig:function(){var a,b,c,e,f,g,h,j;return f=this.$el.find("input"),g=-1,a=i.map(f,function(a,b){var c;return a=d(a),c=a.val().trim(),c||~g||(g=b),c}),~g?(f.eq(g).focus(),void this.trigger("error","请填写统计配置参数，不能为空！")):(e=function(a){return i.map(a.split(","),function(a){return"/"===a.charAt(0)?(a="/"===a.charAt(a.length-1)?a.substring(1,a.length-1):a.substring(1),{value:a,type:"reg"}):{value:a}})},h=this.$el.find(".selectorList.setting"),c=this.$el.find(".dateRow input"),j=i.map(this.$el.find(".selectorList.stats"),function(a){var b;return b=d(a),f=b.find("input"),{category:f.eq(0).val().trim(),key:e(f.eq(1).val().trim())}}),b={stats:j,point:{interval:h.find(".intervalSelector input").val().trim()},type:h.find(".typeSelector input").val().trim(),date:{start:c.eq(0).val().trim(),end:c.eq(1).val().trim()},name:this.$el.find(".function input").val().trim()},console.dir(JSON.stringify(b)),b)},render:function(){var a;return a='<h1 class="page-header">Add</h1><div class="row selectorList stats">'+this.getCategoryList()+this.getKeyList()+'<div class="col-xs-6 col-sm-4"><button class="addCategory btn btn-primary">增加</button></div></div><div class="row selectorList setting">'+this.getIntervalList()+this.getTypeList()+"</div>"+g+h,this.$el.html(a)}}),c.exports=f})}).call(this);