(function(){seajs.use(["jquery","underscore","async","user"],function(a,b,c,d){var e,f;return f=Backbone.View.extend({events:{"click .logIn":"logIn","click .logOut":"logOut"},initialize:function(){return this.listenTo(d,"status",this.changeStatus)},logIn:function(){return d.logIn()},logOut:function(){return d.logOut()},changeStatus:function(a){var b,c,d;return b=this.$el,c=b.find(".logIn"),d=b.find(".logOut"),"logged"!==a?(c.removeClass("hidden"),d.addClass("hidden")):(c.addClass("hidden"),d.removeClass("hidden"))}}),e=Backbone.View.extend({initialize:function(){return this.listenTo(d,"status",this.changeStatus)},changeStatus:function(){return this.$el.find(".name").text(d.get("name"))}}),new f({el:a(".menuContainer")}),new e({el:a(".headerContainer")})})}).call(this);
(function(){define("stats",["jquery","underscore"],function(a,b){var c,d,e;c=a("jquery"),e=a("underscore"),d=60,b.getChartData=function(a,b){return a.interval||(a.interval=d),c.ajax({url:"/stats",dataType:"json",data:a}).success(function(c){return e.isArray(c)?e.each(c,function(b){b.chart=a.chart}):c.chart=a.chart,b(null,c)}).error(b)},b.interval=function(a){return a&&a>0&&(d=a),d}})}).call(this);
(function(){define("chart",["jquery","underscore","echarts","moment","stats"],function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p;p=a("underscore"),c=a("jquery"),j=a("echarts"),n=a("moment"),f=86400,g={tooltip:{trigger:"axis"},calculable:!0,toolbox:{show:!0,feature:{mark:{show:!0},dataView:{show:!0},magicType:{show:!0,type:["line","bar"]},restore:{show:!0},saveAsImage:{show:!0}}},yAxis:[{type:"value"}],animation:!1},h={tooltip:{trigger:"item",formatter:"{a} <br/>{b} : {c} ({d}%)"},toolbox:{show:!0,feature:{mark:{show:!0},dataView:{show:!0},restore:{show:!0},saveAsImage:{show:!0}},calculable:!0}},o=function(a){return p.reduce(a,function(a,b){return a+b},0)},d=function(a){var b;return b=o(a),Math.round(b/a.length)},m=function(a){var b,c;return c=p.map(a,function(a){return p.pluck(a.values,"t")}),b=c.shift(),p.each(c,function(a){return p.each(a,function(a){var c;return c=p.sortedIndex(b,a),b[c]!==a?b.splice(c,0,a):void 0})}),b},e=function(a,b){var c,d,e,f,g;for(e=p.pluck(a,"values"),d=[],c=f=0,g=e.length;g>=0?g>f:f>g;c=g>=0?++f:--f)d.push([]);return p.each(b,function(a){return p.each(e,function(b,c){var e,f;return(null!=(f=b[0])?f.t:void 0)===a?(e=b.shift(),d[c].push(e.v)):d[c].push(0)})}),d},k=function(a,b){var c;return c="YYYY-MM-DD HH:mm:ss",b&&(b%f===0?c="YYYY-MM-DD":b%3600===0?c="YYYY-MM-DD HH":b%60===0&&(c="YYYY-MM-DD HH:mm")),p.map(a,function(a){return n(1e3*a).format(c)})},l=function(a){var b;return b=50,a>b?{show:!0,realtime:!0,start:100-Math.floor(100*b/a),end:100}:null},b.line=function(a,b,c){var d,f,h,n,o;if(null!=b?b.length:void 0)return n=m(b),o=e(b,n),n=k(n,null!=c?c.interval:void 0),h=p.map(b,function(a,b){return{name:a.key,type:a.chart,data:o[b]}}),d=p.extend({},g,{legend:{data:p.pluck(b,"key")},dataZoom:l(n.length),xAxis:[{type:"category",boundaryGap:!1,data:n}],series:h},c),f=j.init(a,i),f.setOption(d,!0)},b.barVertical=b.line,b.stack=function(a,b,c){var d,f,h,n,o;if(null!=b?b.length:void 0)return n=m(b),o=e(b,n),n=k(n,null!=c?c.interval:void 0),h=p.map(b,function(a,b){return{name:a.key,type:a.chart,stack:"总量",data:o[b]}}),d=p.extend({},g,{legend:{data:p.pluck(b,"key")},dataZoom:l(n.length),xAxis:[{type:"category",boundaryGap:!1,data:n}],series:h},c),f=j.init(a,i),f.setOption(d,!0)},b.stackBarVertical=b.stack,b.barHorizontal=function(a,b,c,d){var f,h,n,o,q;return null==d&&(d=!1),(null!=b?b.length:void 0)?(o=m(b),q=e(b,o),o=k(o,null!=c?c.interval:void 0),n=p.map(b,function(a,b){var c;return c={name:a.key,type:a.chart,data:q[b]},d&&(c.stack="总量"),c}),f=p.extend({},g,{legend:{data:p.pluck(b,"key")},dataZoom:l(o.length),xAxis:[{type:"value",boundaryGap:[0,.01]}],yAxis:[{type:"category",data:o}],series:n},c),h=j.init(a,i),h.setOption(f,!0)):void 0},b.stackBarHorizontal=function(a,c,d){return b.barHorizontal(a,c,d,!0)},b.pie=function(a,b,c){var e,f;return b=p.map(b,function(a){var b,c;switch(c=p.pluck(a.values,"v"),a.type){case"counter":b=o(c);break;case"average":b=d(c);break;case"gauge":b=p.last(c)}return{name:a.key,value:b}}),c=p.extend({},h,{legend:{data:p.pluck(b,"name"),orient:"vertical",x:"left",y:"30px"},series:[{name:null!=c&&null!=(f=c.title)?f.text:void 0,type:"pie",data:b}],animation:!1},c),e=j.init(a,i),e.setOption(c,!0)},b.nestedPie=function(){},b.gauge=function(a,b,c){var d,e;return d=p.extend({toolbox:{show:!0,feature:{mark:{show:!0},restore:{show:!0},saveAsImage:{show:!0}}}},c),d.series=p.map(b,function(a){return{name:a.key,type:"gauge",detail:{formatter:"{value}"},data:[{value:a.values[0].v}]}}),e=j.init(a,i),e.setOption(d)},b.funnel=function(a,b,c){var e,f,g;return b=p.map(b,function(a){var b,c;switch(c=p.pluck(a.values,"v"),a.type){case"counter":b=o(c);break;case"average":b=d(c);break;case"gauge":b=p.last(c)}return{name:a.key,value:b}}),f=0,p.each(b,function(a){a.value>f&&(f=a.value)}),p.each(b,function(a){a.value=Math.floor(100*a.value/f)}),console.dir(b),e=p.extend({title:c.title,tooltip:{trigger:"item",formatter:"{b} : {c}%"},toolbox:{show:!0,feature:{mark:{show:!0},dataView:{show:!0,readOnly:!1},restore:{show:!0},saveAsImage:{show:!0}}},legend:{data:p.pluck(b,"name")},calculable:!0,series:[{type:"funnel",data:b}]}),g=j.init(a,i),g.setOption(e,!0)},b.columnFresh=function(a,b,d,e){var f,g,h;return f=p.extend({toolbox:{show:!0,feature:{mark:{show:!0},restore:{show:!0},saveAsImage:{show:!0}}},calculable:!1,yAxis:[{type:"value"}]},d),f.xAxis=[{type:"category",data:p.pluck(b,"key")}],b=p.map(b,function(a){return a.values[0].v}),f.series=[{type:"bar",data:b}],g=c(a).get(0),h=j.init(g,i),h.setOption(f,!0),e?setInterval(function(){return e(function(a,b){return b?(b=p.map(b,function(a){return a.values[0].v}),f.series[0].data=b,h.setOption(f,!0)):void 0})},1e4):void 0},i={color:["#2ec7c9","#b6a2de","#5ab1ef","#ffb980","#d87a80","#8d98b3","#e5cf0d","#97b552","#95706d","#dc69aa","#07a2a4","#9a7fd1","#588dd5","#f5994e","#c05050","#59678c","#c9ab00","#7eb00a","#6f5553","#c14089"],title:{itemGap:8,textStyle:{fontWeight:"normal",color:"#008acd"}},legend:{itemGap:8},dataRange:{itemWidth:15,color:["#2ec7c9","#b6a2de"]},toolbox:{color:["#1e90ff","#1e90ff","#1e90ff","#1e90ff"],effectiveColor:"#ff4500",itemGap:8},tooltip:{backgroundColor:"rgba(50,50,50,0.5)",axisPointer:{type:"line",lineStyle:{color:"#008acd"},crossStyle:{color:"#008acd"},shadowStyle:{color:"rgba(200,200,200,0.2)"}}},dataZoom:{dataBackgroundColor:"#efefff",fillerColor:"rgba(182,162,222,0.2)",handleColor:"#008acd"},grid:{borderColor:"#eee"},categoryAxis:{axisLine:{lineStyle:{color:"#008acd"}},splitLine:{lineStyle:{color:["#eee"]}}},valueAxis:{axisLine:{lineStyle:{color:"#008acd"}},splitArea:{show:!0,areaStyle:{color:["rgba(250,250,250,0.1)","rgba(200,200,200,0.1)"]}},splitLine:{lineStyle:{color:["#eee"]}}},polar:{axisLine:{lineStyle:{color:"#ddd"}},splitArea:{show:!0,areaStyle:{color:["rgba(250,250,250,0.2)","rgba(200,200,200,0.2)"]}},splitLine:{lineStyle:{color:"#ddd"}}},timeline:{lineStyle:{color:"#008acd"},controlStyle:{normal:{color:"#008acd"},emphasis:{color:"#008acd"}},symbol:"emptyCircle",symbolSize:3},bar:{itemStyle:{normal:{borderRadius:5},emphasis:{borderRadius:5}}},line:{smooth:!0,symbol:"emptyCircle",symbolSize:3},k:{itemStyle:{normal:{color:"#d87a80",color0:"#2ec7c9",lineStyle:{width:1,color:"#d87a80",color0:"#2ec7c9"}}}},scatter:{symbol:"circle",symbolSize:4},radar:{symbol:"emptyCircle",symbolSize:3},map:{itemStyle:{normal:{areaStyle:{color:"#ddd"},label:{textStyle:{color:"#d87a80"}}},emphasis:{areaStyle:{color:"#fe994e"},label:{textStyle:{color:"rgb(100,0,0)"}}}}},force:{itemStyle:{normal:{linkStyle:{strokeColor:"#1e90ff"}}}},chord:{padding:4,itemStyle:{normal:{lineStyle:{width:1,color:"rgba(128, 128, 128, 0.5)"},chordStyle:{lineStyle:{width:1,color:"rgba(128, 128, 128, 0.5)"}}},emphasis:{lineStyle:{width:1,color:"rgba(128, 128, 128, 0.5)"},chordStyle:{lineStyle:{width:1,color:"rgba(128, 128, 128, 0.5)"}}}}},gauge:{startAngle:225,endAngle:-45,axisLine:{show:!0,lineStyle:{color:[[.2,"#2ec7c9"],[.8,"#5ab1ef"],[1,"#d87a80"]],width:10}},axisTick:{splitNumber:10,length:15,lineStyle:{color:"auto"}},axisLabel:{textStyle:{color:"auto"}},splitLine:{length:22,lineStyle:{color:"auto"}},pointer:{width:5,color:"auto"},title:{textStyle:{color:"#333"}},detail:{textStyle:{color:"auto"}}},textStyle:{fontFamily:"微软雅黑, Arial, Verdana, sans-serif"}}})}).call(this);
(function(){define("StatsAddView",["jquery","underscore","Backbone"],function(a,b,c){var d,e,f,g,h,i;i=a("underscore"),d=a("jquery"),e=a("Backbone"),g=function(){var a,b,c;return b=function(a,b){return'<div class="col-xs-6 col-sm-4"><div class="input-group"><span class="input-group-addon">'+a+'</span><input type="text" class="form-control" placeholder="'+b+'"></div></div>'},c=function(a){var b,c;return c='<div class="col-xs-6 col-sm-4"><div class="btn-group dateList">',b=i.template('<button type="button" class="btn btn-default" data-start="<%= start %>" data-end="<%= end %>"><%= text %></button>'),i.each(a,function(a){return c+=b(a)}),c+="</div></div>"},a=[{text:"当天",start:0,end:0},{text:"7天",start:-6,end:0},{text:"15天",start:-14,end:0},{text:"30天",start:-29,end:0},{text:"当月",start:"currentMonth",end:0}],'<div class="row dateRow">'+b("开始日期","请输入开始日期(YYYY-MM-DD)")+b("结束日期","请输入结束日期(YYYY-MM-DD)")+c(a)+"</div>"}(),h=function(){var a,b,c,d;return a=i.template('<div class="col-xs-6 col-sm-4"><button class="btn <%= itemClass %>"><%= name %></button></div>'),c=function(b){return a(b)},d='<div class="row function"><div class="col-xs-6 col-sm-4"><div class="input-group"><span class="input-group-addon">名称</span><input type="text" class="form-control" placeholder="请输入该统计的名称"></div></div>',b=[{name:"预览",itemClass:"preview btn-danger"},{name:"保存",itemClass:"save btn-success"}],i.each(b,function(a){return d+=c(a)}),d+="</div>"}(),f=e.View.extend({events:function(){return{"click .categorySelector .dropdown-menu li":"selectCategory","click .keySelector .dropdown-menu li":"selectKey","click .typeSelector .dropdown-menu li":"selectType","click .intervalSelector .dropdown-menu li":"selectInterval","click .dateList .btn":"selectDate","click .function .preview":"preview","click .function .save":"save","click .addCategory":"addCategory","click .deleteCategory":"deleteCategory"}},initialize:function(){return this.render()},getSelector:function(a,b,c,d){var e,f;return null==d&&(d=""),f='<ul class="dropdown-menu" role="menu">',i.each(a,function(a){return f+='<li><a href="javascript:;"><span class="glyphicon"></span>'+a+"</a></li>"}),f+="</ul>",e='<div class="col-xs-6 col-sm-4 '+b+' selector"><div class="input-group"><div class="input-group-btn"><button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">'+c+'<span class="caret"></span></button>'+f+'</div><input type="text" class="form-control" value="'+d+'"></input></div></div>'},getCategoryList:function(){return this.getSelector(JT_GLOBAL.collections,"categorySelector","请选择分类")},getTypeList:function(){return this.getSelector(["line","column","pie","gauge","columnFresh"],"typeSelector","请选择类型")},getIntervalList:function(){return this.getSelector(["1m","10m","30m","1h","2h","6h","12h","1d"],"intervalSelector","请选择时间间隔(秒)",60)},getKeyList:function(a){return this.getSelector(a,"keySelector","请选择key")},addCategory:function(){var a;return a='<div class="row selectorList stats">'+this.getCategoryList()+this.getKeyList()+'<div class="col-xs-6 col-sm-4"><button class="deleteCategory btn btn-warning">删除</button></div></div>',this.$el.find(".selectorList:last").before(a),this},deleteCategory:function(a){return d(a.target).closest(".selectorList").remove(),this},showKeySelector:function(a,b){return d.ajax({url:"/collection/"+a+"/keys",dataType:"json"}).success(function(a){return function(c){var e,f,g;return f=d(a.getKeyList(c)),g=a.$el.find(".selectorList").find(".keySelector").eq(b),e=!1,f.find(".dropdown-menu").on("click",function(){e=!0}),f.find(".input-group-btn").on("hide.bs.dropdown",function(a){e&&a.preventDefault(),e=!1}),g.after(f),g.remove()}}(this)).error(function(){}),this},selectKey:function(a){var b,c,e;return c=d(a.target),c.toggleClass("selected"),c.find(".glyphicon").toggleClass("glyphicon-ok"),e=c.closest(".dropdown-menu").find(".selected"),b=i.map(e,function(a){return d(a).text()}),c.closest(".keySelector").find("input").val(b.join(",")),a.preventDefault()},selectType:function(a){var b,c;return b=d(a.target),c=b.text(),this.$el.find(".typeSelector input").val(c)},selectCategory:function(a){var b,c,e,f;return f=d(a.target),b=f.text(),c=f.closest(".categorySelector"),c.find("input").val(b),e=this.$el.find(".categorySelector").index(c),this.showKeySelector(b,e)},selectDate:function(a){var b,c,e,f;return e=d(a.target),f=e.data("start"),b=e.data("end"),c=this.$el.find(".dateRow .form-control"),c.eq(0).val(f),c.eq(1).val(b)},selectInterval:function(a){var b,c,e;return b=d(a.target).text(),e={m:60,h:3600,d:86400},c=e[b.charAt(b.length-1).toLowerCase()],this.$el.find(".intervalSelector input").val(window.parseInt(b)*c)},preview:function(){var a;return a=this.getConfig(),a?this.trigger("preview",a):void 0},save:function(){var a;return a=this.getConfig(),a?d.ajax({url:"/config",type:"post",dataType:"json",contentType:"application/json",data:JSON.stringify(a)}).success(function(a){return console.dir(a)}).error(function(a){return console.dir(a)}):void 0},getConfig:function(){var a,b,c,e,f,g,h,j;return f=this.$el.find("input"),g=-1,a=i.map(f,function(a,b){var c;return a=d(a),c=a.val().trim(),c||~g||(g=b),c}),~g?(f.eq(g).focus(),void this.trigger("error","请填写统计配置参数，不能为空！")):(e=function(a){return i.map(a.split(","),function(a){return"/"===a.charAt(0)?(a="/"===a.charAt(a.length-1)?a.substring(1,a.length-1):a.substring(1),{value:a,type:"reg"}):{value:a}})},h=this.$el.find(".selectorList.setting"),c=this.$el.find(".dateRow input"),j=i.map(this.$el.find(".selectorList.stats"),function(a){var b;return b=d(a),f=b.find("input"),{category:f.eq(0).val().trim(),key:e(f.eq(1).val().trim())}}),b={stats:j,point:{interval:h.find(".intervalSelector input").val().trim()},type:h.find(".typeSelector input").val().trim(),date:{start:c.eq(0).val().trim(),end:c.eq(1).val().trim()},name:this.$el.find(".function input").val().trim()},console.dir(JSON.stringify(b)),b)},render:function(){var a;return a='<h1 class="page-header">Add</h1><div class="row selectorList stats">'+this.getCategoryList()+this.getKeyList()+'<div class="col-xs-6 col-sm-4"><button class="addCategory btn btn-primary">增加</button></div></div><div class="row selectorList setting">'+this.getIntervalList()+this.getTypeList()+"</div>"+g+h,this.$el.html(a)}}),c.exports=f})}).call(this);
(function(){seajs.use(["jquery","underscore","Backbone","stats","chart"],function(a,b,c,d,e){var f,g,h,i,j,k,l;return f=c.View.extend({showError:function(c){var d;return d=a('<div class="alert alert-danger">'+c+"</div>"),d.appendTo(this.$el),b.delay(function(){return d.remove()},5e3)},showChartView:function(b){var c;return this.chartView&&this.chartView.remove(),c=a('<div class="chartView" />'),c.appendTo(this.$el),seajs.use("ChartView",function(a){return function(d){var e;e=new d({el:c}),e.setOptions(b),e.show(),a.chartView=e}}(this))},showStatsAddView:function(){var b;return this.chartView&&this.chartView.remove(),this.statsAddView&&this.statsAddView.remove(),b=a('<div class="addViewContainer" />'),b.appendTo(this.$el),seajs.use("StatsAddView",function(a){return function(c){var d;d=new c({el:b}),d.on("preview",function(b){return a.showChartView(b)}),d.on("error",function(b){return a.showError(b)}),a.statsAddView=d}}(this))}}),h=new f({el:a("#homeContainer .mainContainer")}),g=c.View.extend({initialize:function(){},events:function(){return{"click .add":"add"}},add:function(){return h.showStatsAddView()}}),l=new g({el:a("#homeContainer .statsList")}),l.add(),i=function(){var b,c;return b=600,c={category:"haproxy",date:{start:"2014-06-28"},key:[{value:"pv"},{value:"pv.category"}],point:{interval:b}},d.getChartData(c,function(c,d){return c?console.error(c):e.line(a(".pvContainer"),d,{interval:b,title:{text:"PV统计"}})})},k=function(){var b;return b={category:"haproxy",key:{value:"resTime.",type:"reg"},date:{start:"2014-06-28"},point:{interval:300}},d.getChartData(b,function(b,c){return b?console.error(b):e.pie(a(".resTimeStatusContainer"),c,{title:{text:"http响应时间"}})})},j=function(){var b;return b={category:"haproxy",key:{value:"reqTotal"},date:{start:"2014-06-28"}},d.getChartData(b,function(b,c){return b?console.error(b):e.column(a(".reqTotalContainer"),c,{title:{text:"http请求总数"}})})},"development"===CONFIG.env?seajs.emit("loadComplete"):void 0})}).call(this);