"use strict";function markdown2html(a){return markdown.toHTML(a.trim()).slice(3,-4)}function Section(a,b){this.heading=a.trim(),this.id=this.heading.replace(/\s+/g,"-").toLowerCase(),this.customizable=b,this.docstring=null,this.subsections=[]}function SubSection(a){this.heading=a.trim(),this.id=this.heading.replace(/\s+/g,"-").toLowerCase(),this.variables=[]}function VarDocstring(a){this.html=markdown2html(a)}function SectionDocstring(a){this.html=markdown2html(a)}function Variable(a,b){this.name=a,this.defaultValue=b,this.docstring=null}function Tokenizer(a){this._lines=a.split("\n"),this._next=void 0}function Parser(a){this._tokenizer=new Tokenizer(a)}var markdown=require("markdown").markdown,CUSTOMIZABLE_HEADING=/^[/]{2}={2}(.*)$/,UNCUSTOMIZABLE_HEADING=/^[/]{2}-{2}(.*)$/,SUBSECTION_HEADING=/^[/]{2}={3}(.*)$/,SECTION_DOCSTRING=/^[/]{2}#{2}(.*)$/,VAR_ASSIGNMENT=/^(@[a-zA-Z0-9_-]+):[ ]*([^ ;][^;]+);[ ]*$/,VAR_DOCSTRING=/^[/]{2}[*]{2}(.*)$/;Section.prototype.addSubSection=function(a){this.subsections.push(a)},SubSection.prototype.addVar=function(a){this.variables.push(a)},Tokenizer.prototype.unshift=function(a){if(void 0!==this._next)throw new Error("Attempted to unshift twice!");this._next=a},Tokenizer.prototype._shift=function(){if(void 0!==this._next){var a=this._next;return this._next=void 0,a}if(this._lines.length<=0)return null;var b=this._lines.shift(),c=null;if(c=SUBSECTION_HEADING.exec(b),null!==c)return new SubSection(c[1]);if(c=CUSTOMIZABLE_HEADING.exec(b),null!==c)return new Section(c[1],!0);if(c=UNCUSTOMIZABLE_HEADING.exec(b),null!==c)return new Section(c[1],!1);if(c=SECTION_DOCSTRING.exec(b),null!==c)return new SectionDocstring(c[1]);if(c=VAR_DOCSTRING.exec(b),null!==c)return new VarDocstring(c[1]);var d=b.lastIndexOf("//"),e=-1===d?b:b.slice(0,d);return c=VAR_ASSIGNMENT.exec(e),null!==c?new Variable(c[1],c[2]):void 0},Tokenizer.prototype.shift=function(){for(;;){var a=this._shift();if(void 0!==a)return a}},Parser.prototype.parseFile=function(){for(var a=[];;){var b=this.parseSection();if(null===b){if(null!==this._tokenizer.shift())throw new Error("Unexpected unparsed section of file remains!");return a}a.push(b)}},Parser.prototype.parseSection=function(){var a=this._tokenizer.shift();if(null===a)return null;if(!(a instanceof Section))throw new Error("Expected section heading; got: "+JSON.stringify(a));var b=this._tokenizer.shift();return b instanceof SectionDocstring?a.docstring=b:this._tokenizer.unshift(b),this.parseSubSections(a),a},Parser.prototype.parseSubSections=function(a){for(;;){var b=this.parseSubSection();if(null===b){if(0!==a.subsections.length)break;b=new SubSection(""),this.parseVars(b)}a.addSubSection(b)}1!==a.subsections.length||a.subsections[0].heading||0!==a.subsections[0].variables.length||(a.subsections=[])},Parser.prototype.parseSubSection=function(){var a=this._tokenizer.shift();return a instanceof SubSection?(this.parseVars(a),a):(this._tokenizer.unshift(a),null)},Parser.prototype.parseVars=function(a){for(;;){var b=this.parseVar();if(null===b)return;a.addVar(b)}},Parser.prototype.parseVar=function(){var a=this._tokenizer.shift();a instanceof VarDocstring||(this._tokenizer.unshift(a),a=null);var b=this._tokenizer.shift();return b instanceof Variable?(b.docstring=a,b):(this._tokenizer.unshift(b),null)},module.exports=Parser;